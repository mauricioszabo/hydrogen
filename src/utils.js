"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.setPreviouslyFocusedElement = exports.char_idx_to_js_idx = exports.js_idx_to_char_idx = exports.executionTime = exports.EmptyMessage = exports.rowRangeForCodeFoldAtBufferRow = exports.hotReloadPackage = exports.log = exports.getEditorDirectory = exports.getEmbeddedScope = exports.kernelSpecProvidesGrammar = exports.isUnsavedFilePath = exports.isMultilanguageGrammar = exports.msgSpecV4toV5 = exports.msgSpecToNotebookFormat = exports.grammarToLanguage = exports.openOrShowDock = exports.focus = exports.reactFactory = exports.NO_EXECTIME_STRING = exports.KERNEL_MONITOR_URI = exports.OUTPUT_AREA_URI = exports.WATCHES_URI = exports.INSPECTOR_URI = void 0;
const atom_1 = require("atom");
const react_1 = __importDefault(require("react"));
const react_dom_1 = __importDefault(require("react-dom"));
const findKey_1 = __importDefault(require("lodash/findKey"));
const os_1 = __importDefault(require("os"));
const path_1 = __importDefault(require("path"));
const config_1 = __importDefault(require("./config"));
const store_1 = __importDefault(require("./store"));
exports.INSPECTOR_URI = "atom://hydrogen/inspector";
exports.WATCHES_URI = "atom://hydrogen/watch-sidebar";
exports.OUTPUT_AREA_URI = "atom://hydrogen/output-area";
exports.KERNEL_MONITOR_URI = "atom://hydrogen/kernel-monitor";
exports.NO_EXECTIME_STRING = "Not available";
function reactFactory(reactElement, domElement, additionalTeardown, disposer = store_1.default.subscriptions) {
    react_dom_1.default.render(reactElement, domElement);
    const disposable = new atom_1.Disposable(() => {
        react_dom_1.default.unmountComponentAtNode(domElement);
        if (typeof additionalTeardown === "function") {
            additionalTeardown();
        }
    });
    disposer.add(disposable);
}
exports.reactFactory = reactFactory;
function focus(item) {
    if (item && typeof item === "object") {
        const editorPane = atom.workspace.paneForItem(item);
        if (editorPane) {
            editorPane.activate();
        }
    }
}
exports.focus = focus;
async function openOrShowDock(URI) {
    let dock = atom.workspace.paneContainerForURI(URI);
    if (dock && typeof dock.show === "function") {
        const pane = atom.workspace.paneForURI(URI);
        if (pane) {
            pane.activateItemForURI(URI);
        }
        return dock.show();
    }
    await atom.workspace.open(URI, {
        searchAllPanes: true,
        activatePane: false,
    });
    dock = atom.workspace.paneContainerForURI(URI);
    return dock && typeof dock.show === "function" ? dock.show() : null;
}
exports.openOrShowDock = openOrShowDock;
function grammarToLanguage(grammar) {
    if (!grammar) {
        return null;
    }
    const grammarLanguage = grammar.name.toLowerCase();
    const mappings = config_1.default.getJson("languageMappings");
    const kernelLanguage = (0, findKey_1.default)(mappings, (l) => l.toLowerCase() === grammarLanguage);
    return kernelLanguage ? kernelLanguage.toLowerCase() : grammarLanguage;
}
exports.grammarToLanguage = grammarToLanguage;
function msgSpecToNotebookFormat(message) {
    return Object.assign({}, message.content, {
        output_type: message.header.msg_type,
    });
}
exports.msgSpecToNotebookFormat = msgSpecToNotebookFormat;
function msgSpecV4toV5(message) {
    switch (message.header.msg_type) {
        case "pyout":
            message.header.msg_type = "execute_result";
            break;
        case "pyerr":
            message.header.msg_type = "error";
            break;
        case "stream":
            if (!message.content.text) {
                message.content.text = message.content.data;
            }
            break;
        default: {
        }
    }
    return message;
}
exports.msgSpecV4toV5 = msgSpecV4toV5;
const markupGrammars = new Set([
    "source.gfm",
    "source.asciidoc",
    "text.restructuredtext",
    "text.tex.latex.knitr",
    "text.md",
    "source.weave.noweb",
    "source.weave.md",
    "source.weave.latex",
    "source.weave.restructuredtext",
    "source.pweave.noweb",
    "source.pweave.md",
    "source.pweave.latex",
    "source.pweave.restructuredtext",
    "source.dyndoc.md.stata",
    "source.dyndoc.latex.stata",
]);
function isMultilanguageGrammar(grammar) {
    return markupGrammars.has(grammar.scopeName);
}
exports.isMultilanguageGrammar = isMultilanguageGrammar;
const isUnsavedFilePath = (filePath) => {
    return filePath.match(/Unsaved\sEditor\s\d+/) ? true : false;
};
exports.isUnsavedFilePath = isUnsavedFilePath;
function kernelSpecProvidesGrammar(kernelSpec, grammar) {
    if (!grammar || !grammar.name || !kernelSpec || !kernelSpec.language) {
        return false;
    }
    const grammarLanguage = grammar.name.toLowerCase();
    const kernelLanguage = kernelSpec.language.toLowerCase();
    if (kernelLanguage === grammarLanguage) {
        return true;
    }
    const mappedLanguage = config_1.default.getJson("languageMappings")[kernelLanguage];
    if (!mappedLanguage) {
        return false;
    }
    return mappedLanguage.toLowerCase() === grammarLanguage;
}
exports.kernelSpecProvidesGrammar = kernelSpecProvidesGrammar;
function getEmbeddedScope(editor, position) {
    const scopes = editor
        .scopeDescriptorForBufferPosition(position)
        .getScopesArray();
    return scopes.find((s) => s.indexOf("source.embedded.") === 0);
}
exports.getEmbeddedScope = getEmbeddedScope;
function getEditorDirectory(editor) {
    if (!editor) {
        return os_1.default.homedir();
    }
    const editorPath = editor.getPath();
    return editorPath ? path_1.default.dirname(editorPath) : os_1.default.homedir();
}
exports.getEditorDirectory = getEditorDirectory;
function log(...message) {
    if (atom.config.get("hydron.debug")) {
        console.log("hydron:", ...message);
    }
}
exports.log = log;
function hotReloadPackage() {
    const packName = "Hydron";
    const packPath = atom.packages.resolvePackagePath(packName);
    if (!packPath) {
        return;
    }
    const packPathPrefix = packPath + path_1.default.sep;
    const zeromqPathPrefix = path_1.default.join(packPath, "node_modules", "zeromq") + path_1.default.sep;
    log(`deactivating ${packName}`);
    atom.packages.deactivatePackage(packName);
    atom.packages.unloadPackage(packName);
    const packageLibsExceptZeromq = (filePath) => filePath.startsWith(packPathPrefix) &&
        !filePath.startsWith(zeromqPathPrefix);
    Object.keys(require.cache)
        .filter(packageLibsExceptZeromq)
        .forEach((filePath) => delete require.cache[filePath]);
    atom.packages.loadPackage(packName);
    atom.packages.activatePackage(packName);
    log(`activated ${packName}`);
}
exports.hotReloadPackage = hotReloadPackage;
function rowRangeForCodeFoldAtBufferRow(editor, row) {
    const range = editor.tokenizedBuffer.getFoldableRangeContainingPoint(new atom_1.Point(row, Infinity), editor.getTabLength());
    return range ? [range.start.row, range.end.row] : null;
}
exports.rowRangeForCodeFoldAtBufferRow = rowRangeForCodeFoldAtBufferRow;
const EmptyMessage = () => {
    return (react_1.default.createElement("ul", { className: "background-message centered" },
        react_1.default.createElement("li", null, "No output to display")));
};
exports.EmptyMessage = EmptyMessage;
function executionTime(message) {
    if (!message.parent_header.date || !message.header.date) {
        return exports.NO_EXECTIME_STRING;
    }
    const start = Date.parse(message.parent_header.date);
    const end = Date.parse(message.header.date);
    const time = end - start;
    let sec = time / 1000;
    if (sec < 60) {
        return `${sec.toFixed(3)} sec`;
    }
    let min = (sec - (sec % 60)) / 60;
    sec = Math.round(sec % 60);
    if (min < 60) {
        return `${min} min ${sec} sec`;
    }
    const hour = (min - (min % 60)) / 60;
    min %= 60;
    return `${hour} h ${min} m ${sec} s`;
}
exports.executionTime = executionTime;
function js_idx_to_char_idx(js_idx, text) {
    if (text === null) {
        return -1;
    }
    let char_idx = js_idx;
    for (let i = 0; i < text.length && i < js_idx; i++) {
        const char_code = text.charCodeAt(i);
        if (char_code >= 0xd800 && char_code < 0xdc00) {
            char_idx -= 1;
        }
    }
    return char_idx;
}
exports.js_idx_to_char_idx = js_idx_to_char_idx;
function char_idx_to_js_idx(char_idx, text) {
    if (text === null) {
        return -1;
    }
    let js_idx = char_idx;
    for (let i = 0; i < text.length && i < js_idx; i++) {
        const char_code = text.charCodeAt(i);
        if (char_code >= 0xd800 && char_code < 0xdc00) {
            js_idx += 1;
        }
    }
    return js_idx;
}
exports.char_idx_to_js_idx = char_idx_to_js_idx;
function setPreviouslyFocusedElement(obj) {
    const activeElement = document.activeElement;
    if (activeElement instanceof HTMLElement) {
        obj.previouslyFocusedElement = activeElement;
    }
}
exports.setPreviouslyFocusedElement = setPreviouslyFocusedElement;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvdXRpbHMudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLCtCQU9jO0FBQ2Qsa0RBQTBCO0FBQzFCLDBEQUFpQztBQUNqQyw2REFBcUM7QUFDckMsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4QixzREFBOEI7QUFDOUIsb0RBQTRCO0FBSWYsUUFBQSxhQUFhLEdBQUcsMkJBQTJCLENBQUM7QUFDNUMsUUFBQSxXQUFXLEdBQUcsK0JBQStCLENBQUM7QUFDOUMsUUFBQSxlQUFlLEdBQUcsNkJBQTZCLENBQUM7QUFDaEQsUUFBQSxrQkFBa0IsR0FBRyxnQ0FBZ0MsQ0FBQztBQUN0RCxRQUFBLGtCQUFrQixHQUFHLGVBQWUsQ0FBQztBQUNsRCxTQUFnQixZQUFZLENBQzFCLFlBQWdFLEVBQ2hFLFVBQXVCLEVBQ3ZCLGtCQUFzRSxFQUN0RSxXQUFnQyxlQUFLLENBQUMsYUFBYTtJQUVuRCxtQkFBUSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDMUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxpQkFBVSxDQUFDLEdBQUcsRUFBRTtRQUNyQyxtQkFBUSxDQUFDLHNCQUFzQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzVDLElBQUksT0FBTyxrQkFBa0IsS0FBSyxVQUFVLEVBQUU7WUFDNUMsa0JBQWtCLEVBQUUsQ0FBQztTQUN0QjtJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBZEQsb0NBY0M7QUFDRCxTQUFnQixLQUFLLENBQUMsSUFBZ0M7SUFDcEQsSUFBSSxJQUFJLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQ3BDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELElBQUksVUFB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TSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUdyQyxJQUFJLFNBQVMsSUFBSSxNQUFNLElBQUksU0FBUyxHQUFHLE1BQU0sRUFBRTtZQUM3QyxNQUFNLElBQUksQ0FBQyxDQUFDO1NBQ2I7S0FDRjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFoQkQsZ0RBZ0JDO0FBTUQsU0FBZ0IsMkJBQTJCLENBQUMsR0FFM0M7SUFDQyxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDO0lBQzdDLElBQUksYUFBYSxZQUFZLFdBQVcsRUFBRTtRQUN4QyxHQUFHLENBQUMsd0JBQXdCLEdBQUcsYUFBYSxDQUFDO0tBQzlDO0FBQ0gsQ0FBQztBQVBELGtFQU9DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgVGV4dEVkaXRvcixcbiAgQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgRGlzcG9zYWJsZSxcbiAgUG9pbnQsXG4gIEdyYW1tYXIsXG4gIERvY2ssXG59IGZyb20gXCJhdG9tXCI7XG5pbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgUmVhY3RET00gZnJvbSBcInJlYWN0LWRvbVwiO1xuaW1wb3J0IGZpbmRLZXkgZnJvbSBcImxvZGFzaC9maW5kS2V5XCI7XG5pbXBvcnQgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBzdG9yZSBmcm9tIFwiLi9zdG9yZVwiO1xuaW1wb3J0IHR5cGUgeyBNZXNzYWdlIH0gZnJvbSBcIi4vaHlkcm9nZW5cIjtcbmltcG9ydCB0eXBlIHsgS2VybmVsc3BlY01ldGFkYXRhIH0gZnJvbSBcIkBudGVyYWN0L3R5cGVzXCI7XG5cbmV4cG9ydCBjb25zdCBJTlNQRUNUT1JfVVJJID0gXCJhdG9tOi8vaHlkcm9nZW4vaW5zcGVjdG9yXCI7XG5leHBvcnQgY29uc3QgV0FUQ0hFU19VUkkgPSBcImF0b206Ly9oeWRyb2dlbi93YXRjaC1zaWRlYmFyXCI7XG5leHBvcnQgY29uc3QgT1VUUFVUX0FSRUFfVVJJID0gXCJhdG9tOi8vaHlkcm9nZW4vb3V0cHV0LWFyZWFcIjtcbmV4cG9ydCBjb25zdCBLRVJORUxfTU9OSVRPUl9VUkkgPSBcImF0b206Ly9oeWRyb2dlbi9rZXJuZWwtbW9uaXRvclwiO1xuZXhwb3J0IGNvbnN0IE5PX0VYRUNUSU1FX1NUUklORyA9IFwiTm90IGF2YWlsYWJsZVwiO1xuZXhwb3J0IGZ1bmN0aW9uIHJlYWN0RmFjdG9yeShcbiAgcmVhY3RFbGVtZW50OiBSZWFjdC5SZWFjdEVsZW1lbnQ8UmVhY3QuQ29tcG9uZW50UHJvcHM8YW55PiwgYW55PixcbiAgZG9tRWxlbWVudDogSFRNTEVsZW1lbnQsXG4gIGFkZGl0aW9uYWxUZWFyZG93bj86ICgoLi4uYXJnczogQXJyYXk8YW55PikgPT4gYW55KSB8IG51bGwgfCB1bmRlZmluZWQsXG4gIGRpc3Bvc2VyOiBDb21wb3NpdGVEaXNwb3NhYmxlID0gc3RvcmUuc3Vic2NyaXB0aW9uc1xuKSB7XG4gIFJlYWN0RE9NLnJlbmRlcihyZWFjdEVsZW1lbnQsIGRvbUVsZW1lbnQpO1xuICBjb25zdCBkaXNwb3NhYmxlID0gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUoZG9tRWxlbWVudCk7XG4gICAgaWYgKHR5cGVvZiBhZGRpdGlvbmFsVGVhcmRvd24gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgYWRkaXRpb25hbFRlYXJkb3duKCk7XG4gICAgfVxuICB9KTtcbiAgZGlzcG9zZXIuYWRkKGRpc3Bvc2FibGUpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGZvY3VzKGl0ZW06IHVua25vd24gfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gIGlmIChpdGVtICYmIHR5cGVvZiBpdGVtID09PSBcIm9iamVjdFwiKSB7XG4gICAgY29uc3QgZWRpdG9yUGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pO1xuICAgIGlmIChlZGl0b3JQYW5lKSB7XG4gICAgICBlZGl0b3JQYW5lLmFjdGl2YXRlKCk7XG4gICAgfVxuICB9XG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gb3Blbk9yU2hvd0RvY2soXG4gIFVSSTogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQgfCBudWxsIHwgdW5kZWZpbmVkPiB7XG4gIC8vIGF0b20ud29ya3NwYWNlLm9wZW4oVVJJKSB3aWxsIGFjdGl2YXRlL2ZvY3VzIHRoZSBkb2NrIGJ5IGRlZmF1bHRcbiAgLy8gZG9jay50b2dnbGUoKSBvciBkb2NrLnNob3coKSB3aWxsIGxlYXZlIGZvY3VzIHdoZXJldmVyIGl0IHdhc1xuICAvLyB0aGlzIGZ1bmN0aW9uIGlzIGJhc2ljYWxseSB3b3Jrc3BhY2Uub3BlbiwgZXhjZXB0IGl0XG4gIC8vIHdpbGwgbm90IGZvY3VzIHRoZSBuZXdseSBvcGVuZWQgcGFuZVxuICBsZXQgZG9jayA9IGF0b20ud29ya3NwYWNlLnBhbmVDb250YWluZXJGb3JVUkkoVVJJKTtcblxuICBpZiAoZG9jayAmJiB0eXBlb2YgZG9jay5zaG93ID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAvLyBJZiB0aGUgdGFyZ2V0IGl0ZW0gYWxyZWFkeSBleGlzdCwgYWN0aXZhdGUgaXQgYW5kIHNob3cgZG9ja1xuICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9yVVJJKFVSSSk7XG4gICAgaWYgKHBhbmUpIHtcbiAgICAgIHBhbmUuYWN0aXZhdGVJdGVtRm9yVVJJKFVSSSk7XG4gICAgfVxuICAgIHJldHVybiAoZG9jayBhcyBEb2NrKS5zaG93KCk7XG4gIH1cblxuICBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKFVSSSwge1xuICAgIHNlYXJjaEFsbFBhbmVzOiB0cnVlLFxuICAgIGFjdGl2YXRlUGFuZTogZmFsc2UsXG4gIH0pO1xuICBkb2NrID0gYXRvbS53b3Jrc3BhY2UucGFuZUNvbnRhaW5lckZvclVSSShVUkkpO1xuICByZXR1cm4gZG9jayAmJiB0eXBlb2YgZG9jay5zaG93ID09PSBcImZ1bmN0aW9uXCIgPyAoZG9jayBhcyBEb2NrKS5zaG93KCkgOiBudWxsO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdyYW1tYXJUb0xhbmd1YWdlKGdyYW1tYXI6IEdyYW1tYXIgfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gIGlmICghZ3JhbW1hcikge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGNvbnN0IGdyYW1tYXJMYW5ndWFnZSA9IGdyYW1tYXIubmFtZS50b0xvd2VyQ2FzZSgpO1xuICBjb25zdCBtYXBwaW5ncyA9IENvbmZpZy5nZXRKc29uKFwibGFuZ3VhZ2VNYXBwaW5nc1wiKTtcblxuICBjb25zdCBrZXJuZWxMYW5ndWFnZSA9IGZpbmRLZXkoXG4gICAgbWFwcGluZ3MsXG4gICAgKGwpID0+IGwudG9Mb3dlckNhc2UoKSA9PT0gZ3JhbW1hckxhbmd1YWdlXG4gICk7XG5cbiAgcmV0dXJuIGtlcm5lbExhbmd1YWdlID8ga2VybmVsTGFuZ3VhZ2UudG9Mb3dlckNhc2UoKSA6IGdyYW1tYXJMYW5ndWFnZTtcbn1cblxuLyoqXG4gKiBDb3BpZWQgZnJvbVxuICogaHR0cHM6Ly9naXRodWIuY29tL250ZXJhY3QvbnRlcmFjdC9ibG9iL21hc3Rlci9zcmMvbm90ZWJvb2svZXBpY3MvZXhlY3V0ZS5qcyNMMzdcbiAqIENyZWF0ZSBhbiBvYmplY3QgdGhhdCBhZGhlcmVzIHRvIHRoZSBqdXB5dGVyIG5vdGVib29rIHNwZWNpZmljYXRpb24uXG4gKiBodHRwOi8vanVweXRlci1jbGllbnQucmVhZHRoZWRvY3MuaW8vZW4vbGF0ZXN0L21lc3NhZ2luZy5odG1sXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG1zZyAtIE1lc3NhZ2UgdGhhdCBoYXMgY29udGVudCB3aGljaCBjYW4gYmUgY29udmVydGVkIHRvIG5iZm9ybWF0XG4gKiBAcmV0dXJucyB7T2JqZWN0fSBGb3JtYXR0ZWRNc2cgLSBNZXNzYWdlIHdpdGggdGhlIGFzc29jaWF0ZWQgb3V0cHV0IHR5cGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1zZ1NwZWNUb05vdGVib29rRm9ybWF0KG1lc3NhZ2U6IE1lc3NhZ2UpIHtcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIG1lc3NhZ2UuY29udGVudCwge1xuICAgIG91dHB1dF90eXBlOiBtZXNzYWdlLmhlYWRlci5tc2dfdHlwZSxcbiAgfSk7XG59XG5cbi8qKiBBIHZlcnkgYmFzaWMgY29udmVydGVyIGZvciBzdXBwb3J0aW5nIGp1cHl0ZXIgbWVzc2FnaW5nIHByb3RvY29sIHY0IHJlcGxpZXMgKi9cbmV4cG9ydCBmdW5jdGlvbiBtc2dTcGVjVjR0b1Y1KG1lc3NhZ2U6IE1lc3NhZ2UpIHtcbiAgc3dpdGNoIChtZXNzYWdlLmhlYWRlci5tc2dfdHlwZSkge1xuICAgIGNhc2UgXCJweW91dFwiOlxuICAgICAgbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUgPSBcImV4ZWN1dGVfcmVzdWx0XCI7XG4gICAgICBicmVhaztcblxuICAgIGNhc2UgXCJweWVyclwiOlxuICAgICAgbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUgPSBcImVycm9yXCI7XG4gICAgICBicmVhaztcblxuICAgIGNhc2UgXCJzdHJlYW1cIjpcbiAgICAgIGlmICghbWVzc2FnZS5jb250ZW50LnRleHQpIHtcbiAgICAgICAgbWVzc2FnZS5jb250ZW50LnRleHQgPSBtZXNzYWdlLmNvbnRlbnQuZGF0YTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6IHtcbiAgICAgIC8vIG5vIGNvbnZlcnNpb24gbmVlZGVkXG4gICAgfVxuICB9XG4gIHJldHVybiBtZXNzYWdlO1xufVxuY29uc3QgbWFya3VwR3JhbW1hcnMgPSBuZXcgU2V0KFtcbiAgXCJzb3VyY2UuZ2ZtXCIsXG4gIFwic291cmNlLmFzY2lpZG9jXCIsXG4gIFwidGV4dC5yZXN0cnVjdHVyZWR0ZXh0XCIsXG4gIFwidGV4dC50ZXgubGF0ZXgua25pdHJcIixcbiAgXCJ0ZXh0Lm1kXCIsXG4gIFwic291cmNlLndlYXZlLm5vd2ViXCIsXG4gIFwic291cmNlLndlYXZlLm1kXCIsXG4gIFwic291cmNlLndlYXZlLmxhdGV4XCIsXG4gIFwic291cmNlLndlYXZlLnJlc3RydWN0dXJlZHRleHRcIixcbiAgXCJzb3VyY2UucHdlYXZlLm5vd2ViXCIsXG4gIFwic291cmNlLnB3ZWF2ZS5tZFwiLFxuICBcInNvdXJjZS5wd2VhdmUubGF0ZXhcIixcbiAgXCJzb3VyY2UucHdlYXZlLnJlc3RydWN0dXJlZHRleHRcIixcbiAgXCJzb3VyY2UuZHluZG9jLm1kLnN0YXRhXCIsXG4gIFwic291cmNlLmR5bmRvYy5sYXRleC5zdGF0YVwiLFxuXSk7XG5leHBvcnQgZnVuY3Rpb24gaXNNdWx0aWxhbmd1YWdlR3JhbW1hcihncmFtbWFyOiBHcmFtbWFyKSB7XG4gIHJldHVybiBtYXJrdXBHcmFtbWFycy5oYXMoZ3JhbW1hci5zY29wZU5hbWUpO1xufVxuZXhwb3J0IGNvbnN0IGlzVW5zYXZlZEZpbGVQYXRoID0gKGZpbGVQYXRoOiBzdHJpbmcpOiBib29sZWFuID0+IHtcbiAgcmV0dXJuIGZpbGVQYXRoLm1hdGNoKC9VbnNhdmVkXFxzRWRpdG9yXFxzXFxkKy8pID8gdHJ1ZSA6IGZhbHNlO1xufTtcbmV4cG9ydCBmdW5jdGlvbiBrZXJuZWxTcGVjUHJvdmlkZXNHcmFtbWFyKFxuICBrZXJuZWxTcGVjOiBLZXJuZWxzcGVjTWV0YWRhdGEsXG4gIGdyYW1tYXI6IEdyYW1tYXIgfCBudWxsIHwgdW5kZWZpbmVkXG4pIHtcbiAgaWYgKCFncmFtbWFyIHx8ICFncmFtbWFyLm5hbWUgfHwgIWtlcm5lbFNwZWMgfHwgIWtlcm5lbFNwZWMubGFuZ3VhZ2UpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBjb25zdCBncmFtbWFyTGFuZ3VhZ2UgPSBncmFtbWFyLm5hbWUudG9Mb3dlckNhc2UoKTtcbiAgY29uc3Qga2VybmVsTGFuZ3VhZ2UgPSBrZXJuZWxTcGVjLmxhbmd1YWdlLnRvTG93ZXJDYXNlKCk7XG5cbiAgaWYgKGtlcm5lbExhbmd1YWdlID09PSBncmFtbWFyTGFuZ3VhZ2UpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNvbnN0IG1hcHBlZExhbmd1YWdlID0gQ29uZmlnLmdldEpzb24oXCJsYW5ndWFnZU1hcHBpbmdzXCIpW2tlcm5lbExhbmd1YWdlXTtcblxuICBpZiAoIW1hcHBlZExhbmd1YWdlKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIG1hcHBlZExhbmd1YWdlLnRvTG93ZXJDYXNlKCkgPT09IGdyYW1tYXJMYW5ndWFnZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRFbWJlZGRlZFNjb3BlKFxuICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gIHBvc2l0aW9uOiBQb2ludFxuKTogc3RyaW5nIHwgbnVsbCB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IHNjb3BlcyA9IGVkaXRvclxuICAgIC5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihwb3NpdGlvbilcbiAgICAuZ2V0U2NvcGVzQXJyYXkoKTtcbiAgcmV0dXJuIHNjb3Blcy5maW5kKChzKSA9PiBzLmluZGV4T2YoXCJzb3VyY2UuZW1iZWRkZWQuXCIpID09PSAwKTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRFZGl0b3JEaXJlY3RvcnkoZWRpdG9yOiBUZXh0RWRpdG9yIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICBpZiAoIWVkaXRvcikge1xuICAgIHJldHVybiBvcy5ob21lZGlyKCk7XG4gIH1cbiAgY29uc3QgZWRpdG9yUGF0aCA9IGVkaXRvci5nZXRQYXRoKCk7XG4gIHJldHVybiBlZGl0b3JQYXRoID8gcGF0aC5kaXJuYW1lKGVkaXRvclBhdGgpIDogb3MuaG9tZWRpcigpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGxvZyguLi5tZXNzYWdlOiBBcnJheTxhbnk+KSB7XG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoXCJIeWRyb2dlbi5kZWJ1Z1wiKSkge1xuICAgIGNvbnNvbGUubG9nKFwiSHlkcm9nZW46XCIsIC4uLm1lc3NhZ2UpO1xuICB9XG59XG5leHBvcnQgZnVuY3Rpb24gaG90UmVsb2FkUGFja2FnZSgpIHtcbiAgY29uc3QgcGFja05hbWUgPSBcIkh5ZHJvZ2VuXCI7XG4gIGNvbnN0IHBhY2tQYXRoID0gYXRvbS5wYWNrYWdlcy5yZXNvbHZlUGFja2FnZVBhdGgocGFja05hbWUpO1xuICBpZiAoIXBhY2tQYXRoKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGNvbnN0IHBhY2tQYXRoUHJlZml4ID0gcGFja1BhdGggKyBwYXRoLnNlcDtcbiAgY29uc3QgemVyb21xUGF0aFByZWZpeCA9XG4gICAgcGF0aC5qb2luKHBhY2tQYXRoLCBcIm5vZGVfbW9kdWxlc1wiLCBcInplcm9tcVwiKSArIHBhdGguc2VwO1xuICBsb2coYGRlYWN0aXZhdGluZyAke3BhY2tOYW1lfWApO1xuICBhdG9tLnBhY2thZ2VzLmRlYWN0aXZhdGVQYWNrYWdlKHBhY2tOYW1lKTtcbiAgYXRvbS5wYWNrYWdlcy51bmxvYWRQYWNrYWdlKHBhY2tOYW1lKTtcblxuICAvLyBEZWxldGUgcmVxdWlyZSBjYWNoZSB0byByZS1yZXF1aXJlIG9uIGFjdGl2YXRpb24uXG4gIC8vIEJ1dCBleGNlcHQgemVyb21xIG5hdGl2ZSBtb2R1bGUgd2hpY2ggaXMgbm90IHJlLXJlcXVpcmVhYmxlLlxuICBjb25zdCBwYWNrYWdlTGlic0V4Y2VwdFplcm9tcSA9IChmaWxlUGF0aCkgPT5cbiAgICBmaWxlUGF0aC5zdGFydHNXaXRoKHBhY2tQYXRoUHJlZml4KSAmJlxuICAgICFmaWxlUGF0aC5zdGFydHNXaXRoKHplcm9tcVBhdGhQcmVmaXgpO1xuXG4gIE9iamVjdC5rZXlzKHJlcXVpcmUuY2FjaGUpXG4gICAgLmZpbHRlcihwYWNrYWdlTGlic0V4Y2VwdFplcm9tcSlcbiAgICAuZm9yRWFjaCgoZmlsZVBhdGgpID0+IGRlbGV0ZSByZXF1aXJlLmNhY2hlW2ZpbGVQYXRoXSk7XG4gIGF0b20ucGFja2FnZXMubG9hZFBhY2thZ2UocGFja05hbWUpO1xuICBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZShwYWNrTmFtZSk7XG4gIGxvZyhgYWN0aXZhdGVkICR7cGFja05hbWV9YCk7XG59XG5leHBvcnQgZnVuY3Rpb24gcm93UmFuZ2VGb3JDb2RlRm9sZEF0QnVmZmVyUm93KFxuICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gIHJvdzogbnVtYmVyXG4pIHtcbiAgLy8gJEZsb3dGaXhNZVxuICBjb25zdCByYW5nZSA9IGVkaXRvci50b2tlbml6ZWRCdWZmZXIuZ2V0Rm9sZGFibGVSYW5nZUNvbnRhaW5pbmdQb2ludChcbiAgICBuZXcgUG9pbnQocm93LCBJbmZpbml0eSksXG4gICAgZWRpdG9yLmdldFRhYkxlbmd0aCgpXG4gICk7XG4gIHJldHVybiByYW5nZSA/IFtyYW5nZS5zdGFydC5yb3csIHJhbmdlLmVuZC5yb3ddIDogbnVsbDtcbn1cbmV4cG9ydCBjb25zdCBFbXB0eU1lc3NhZ2UgPSAoKSA9PiB7XG4gIHJldHVybiAoXG4gICAgPHVsIGNsYXNzTmFtZT1cImJhY2tncm91bmQtbWVzc2FnZSBjZW50ZXJlZFwiPlxuICAgICAgPGxpPk5vIG91dHB1dCB0byBkaXNwbGF5PC9saT5cbiAgICA8L3VsPlxuICApO1xufTtcbi8vIFRPRE86IHVzZSBucG0gcGFja2FnZSAtLSBtYXliZSBpdCBvZmZlcnMgbW9yZSByb2J1c3QgaW1wbGVtZW50YXRpb25cblxuLyoqXG4gKiBHaXZlbiBhIG1lc3NhZ2Ugd2hvc2UgdHlwZSBpZiBgZXhlY3V0ZV9yZXBseWAsIGNhbGN1bGF0ZXMgZXhlY3Rpb24gdGltZSBhbmRcbiAqIHJldHVybnMgaXRzIHN0cmluZyByZXByZXNlbnRhdGlvbi5cbiAqXG4gKiBAcGFyYW0ge01lc3NhZ2V9IG1lc3NhZ2UgLSBBIE1lc3NhZ2Ugb2JqZWN0IHdob3NlIHR5cGUgaXMgYGV4ZWN1dGVfcmVwbHlgXG4gKiBAcmV0dXJucyB7U3RyaW5nfSAtIEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBleGVjdXRpb24gdGltZS4gUmV0dXJuc1xuICogICBgTk9fRVhFQ1RJTUVfU1RSSU5HYCBpZiBleGVjdXRpb24gdGltZSBpcyB1bmF2YWlsYWJsZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGlvblRpbWUobWVzc2FnZTogTWVzc2FnZSk6IHN0cmluZyB7XG4gIGlmICghbWVzc2FnZS5wYXJlbnRfaGVhZGVyLmRhdGUgfHwgIW1lc3NhZ2UuaGVhZGVyLmRhdGUpIHtcbiAgICByZXR1cm4gTk9fRVhFQ1RJTUVfU1RSSU5HO1xuICB9XG5cbiAgY29uc3Qgc3RhcnQgPSBEYXRlLnBhcnNlKG1lc3NhZ2UucGFyZW50X2hlYWRlci5kYXRlKTtcbiAgY29uc3QgZW5kID0gRGF0ZS5wYXJzZShtZXNzYWdlLmhlYWRlci5kYXRlKTtcbiAgY29uc3QgdGltZSA9IGVuZCAtIHN0YXJ0OyAvLyBtaWxsaXNlY29uZHNcblxuICBsZXQgc2VjID0gdGltZSAvIDEwMDA7IC8vIHNlY29uZHNcblxuICBpZiAoc2VjIDwgNjApIHtcbiAgICByZXR1cm4gYCR7c2VjLnRvRml4ZWQoMyl9IHNlY2A7XG4gIH1cblxuICBsZXQgbWluID0gKHNlYyAtIChzZWMgJSA2MCkpIC8gNjA7XG4gIHNlYyA9IE1hdGgucm91bmQoc2VjICUgNjApO1xuXG4gIGlmIChtaW4gPCA2MCkge1xuICAgIHJldHVybiBgJHttaW59IG1pbiAke3NlY30gc2VjYDtcbiAgfVxuXG4gIGNvbnN0IGhvdXIgPSAobWluIC0gKG1pbiAlIDYwKSkgLyA2MDtcbiAgbWluICU9IDYwO1xuICByZXR1cm4gYCR7aG91cn0gaCAke21pbn0gbSAke3NlY30gc2A7XG59XG5leHBvcnQgZnVuY3Rpb24ganNfaWR4X3RvX2NoYXJfaWR4KGpzX2lkeDogbnVtYmVyLCB0ZXh0OiBzdHJpbmcgfCBudWxsKSB7XG4gIGlmICh0ZXh0ID09PSBudWxsKSB7XG4gICAgcmV0dXJuIC0xO1xuICB9XG4gIGxldCBjaGFyX2lkeCA9IGpzX2lkeDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IHRleHQubGVuZ3RoICYmIGkgPCBqc19pZHg7IGkrKykge1xuICAgIGNvbnN0IGNoYXJfY29kZSA9IHRleHQuY2hhckNvZGVBdChpKTtcblxuICAgIC8vIGNoZWNrIGZvciB0aGUgZmlyc3QgaGFsZiBvZiBhIHN1cnJvZ2F0ZSBwYWlyXG4gICAgaWYgKGNoYXJfY29kZSA+PSAweGQ4MDAgJiYgY2hhcl9jb2RlIDwgMHhkYzAwKSB7XG4gICAgICBjaGFyX2lkeCAtPSAxO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBjaGFyX2lkeDtcbn1cbmV4cG9ydCBmdW5jdGlvbiBjaGFyX2lkeF90b19qc19pZHgoY2hhcl9pZHg6IG51bWJlciwgdGV4dDogc3RyaW5nIHwgbnVsbCkge1xuICBpZiAodGV4dCA9PT0gbnVsbCkge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICBsZXQganNfaWR4ID0gY2hhcl9pZHg7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZXh0Lmxlbmd0aCAmJiBpIDwganNfaWR4OyBpKyspIHtcbiAgICBjb25zdCBjaGFyX2NvZGUgPSB0ZXh0LmNoYXJDb2RlQXQoaSk7XG5cbiAgICAvLyBjaGVjayBmb3IgdGhlIGZpcnN0IGhhbGYgb2YgYSBzdXJyb2dhdGUgcGFpclxuICAgIGlmIChjaGFyX2NvZGUgPj0gMHhkODAwICYmIGNoYXJfY29kZSA8IDB4ZGMwMCkge1xuICAgICAganNfaWR4ICs9IDE7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGpzX2lkeDtcbn1cblxuLyoqXG4gKiBTZXRzIHRoZSBgcHJldmlvdXNseUZvY3VzZWRFbGVtZW50YCBwcm9wZXJ0eSBvZiB0aGUgZ2l2ZW4gb2JqZWN0IHRvXG4gKiBhY3RpdmVFbGVtZW50IGlmIGl0IGlzIGFuIEhUTUxFbGVtZW50XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzZXRQcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQob2JqOiB7XG4gIHByZXZpb3VzbHlGb2N1c2VkRWxlbWVudDogSFRNTEVsZW1lbnQgfCBudWxsIHwgdW5kZWZpbmVkO1xufSkge1xuICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgaWYgKGFjdGl2ZUVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgIG9iai5wcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQgPSBhY3RpdmVFbGVtZW50O1xuICB9XG59XG5cbi8qKiBNYWtlIHRoZSBwcm9wZXJ0aWVzIG9mIGEgdHlwZSBXcml0YWJsZSAqL1xuZXhwb3J0IHR5cGUgV3JpdGVhYmxlPFQ+ID0geyAtcmVhZG9ubHkgW1AgaW4ga2V5b2YgVF06IFRbUF0gfTtcblxuLyoqIE1ha2UgdGhlIHByb3BlcnRpZXMgb2YgYWV4cG9ydCB0eXBlIFdyaXRhYmxlIHJlY3Vyc2l2ZWx5ICovXG5leHBvcnQgdHlwZSBEZWVwV3JpdGVhYmxlPFQ+ID0ge1xuICAtcmVhZG9ubHkgW1AgaW4ga2V5b2YgVF06IERlZXBXcml0ZWFibGU8VFtQXT47XG59O1xuIl19